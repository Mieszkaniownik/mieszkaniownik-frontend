substitutions:
  _CLUSTER_NAME: mieszkaniownik-prod-cluster
  _CLUSTER_ZONE: europe-central2-a
  _NAMESPACE: production
  _IMAGE_NAME: mieszkaniownik-frontend
  _HELM_RELEASE: mieszkaniownik-frontend

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/google-maps-api-key-prod/versions/latest
      env: 'VITE_GOOGLE_MAPS_API_KEY'
    - versionName: projects/$PROJECT_ID/secrets/vite-api-url-prod/versions/latest
      env: 'VITE_API_URL'

steps:
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    secretEnv: ['VITE_GOOGLE_MAPS_API_KEY', 'VITE_API_URL']
    args:
      - 'build'
      - '--tag=eu.gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA'
      - '--tag=eu.gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest'
      - '--build-arg=VITE_API_URL=$$VITE_API_URL'
      - '--build-arg=VITE_GOOGLE_MAPS_API_KEY=$$VITE_GOOGLE_MAPS_API_KEY'
      - '--build-arg=NODE_ENV=production'
      - '--cache-from=eu.gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest'
      - '.'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args:
      - 'push'
      - 'eu.gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-latest'
    args:
      - 'push'
      - 'eu.gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest'

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'get-credentials'
    args:
      - 'container'
      - 'clusters'
      - 'get-credentials'
      - '${_CLUSTER_NAME}'
      - '--zone=${_CLUSTER_ZONE}'

  - name: 'gcr.io/$PROJECT_ID/helm'
    id: 'helm-deploy'
    args:
      - 'upgrade'
      - '--install'
      - '${_HELM_RELEASE}'
      - './helm-chart-frontend'
      - '--namespace=${_NAMESPACE}'
      - '--create-namespace'
      - '--values=./helm-chart-frontend/values.yaml'
      - '--values=./helm-chart-frontend/values-prod.yaml'
      - '--set=frontend.image.repository=eu.gcr.io/$PROJECT_ID/${_IMAGE_NAME}'
      - '--set=frontend.image.tag=$SHORT_SHA'
      - '--set=global.imageRegistry='
      - '--wait'
      - '--timeout=10m'

  - name: 'gcr.io/cloud-builders/kubectl'
    id: 'verify-deployment'
    args:
      - 'rollout'
      - 'status'
      - 'deployment/${_HELM_RELEASE}'
      - '-n'
      - '${_NAMESPACE}'
      - '--timeout=5m'

images:
  - 'eu.gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA'
  - 'eu.gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest'

timeout: '1800s'
